# Metrics Library

## Available languages

1. [Russian](README.md)
2. [English](README-en.md)

## Краткое описание

`vk_metrics_lib` — высокопроизводительная C++‑библиотека для сбора, агрегации и периодической записи метрик в текстовый файл. Основные применённые технологии:

1. **Lock‑free структуры данных**  
  `LockFreeQueue<T>` и `LockFreeStack<T>` позволяют записывать данные из рабочих потоков без блокировок и гонок, что гарантирует минимальные задержки.

2. **Hazard pointers**  
  Собственная реализация обеспечивает безопасную очистку памяти в lock‑free контейнерах без риска use-after-free и без глобальных блокировок.

3. **Шаблонная расширяемая архитектура**  
  Интерфейс `IMetric` задаёт единый контракт для метрик и позволяет хранить наследников разных типов в одном контейнере. Базовые классы `OrderedMetricBase<T>` и `UnorderedMetricBase<T>` реализуют механику буферизации с помощью lock‑free структур, а конкретные метрики (`CountMetric<T>`, `AverageMetric<T>` и др.) наследуются от них и реализуют лишь метод `AggregateAndReset()`, отвечающий за логику агрегации накопленных значений. Пользователь может добавлять новые метрики без изменений в ядре библиотеки, создавая собственный класс-наследник от соответствующего `<...>MetricBase<T>`.

4. **Registry и MetricsWriter**  
  Синглтон `Registry` централизованно хранит все созданные метрики и управляет их временем жизни. `MetricsWriter` в отдельном потоке каждые `delta` миллисекунд читает, записывает в файл и обнуляет накопленные значения во всех метриках. Запись файл происходит в формате
  `yyyy-mm-dd hh:mm:ss.msmsms "name_1" <value_1> "name_2" <value_2> ...`.

### Соответствие требованиям

- **Расширяемость**: новые метрики добавляются через наследование и регистрацию шаблонным методом — без правок в существующем коде.  
- **Неблокирующая запись**: метод `SomeMetric::Record()` не использует мьютексы — все вставки происходят в lock‑free контейнер.  
- **Автоматический сброс**: после каждой записи `MetricsWriter` очищает буфер метрик, готовя их к следующему циклу измерений.  

## Структура проекта

- **`.github/workflows/ci.yml`** — CI-workflow, автоматически выполняет сборку, форматирование, и прогон тестов при каждом push/pull request.
- **`examples/`** содержит два примера (исходный код и текстовый файл с записанными данными):  
  - **`cpu_and_http_metrics/`** — использование `CountMetric<int>` и `AverageMetric<double>` для сбора средней утилиазции CPU и HTTP-RPS;
  - **`custom_metrics/`** — демонстрация создания пользовательской метрики `SequenceMetric<T>`.
- **`external/`** — встроенный GoogleTest для тестирования без внешних зависимостей.
- **`scripts/`** — Shell-скрипты для сборки, проверки форматирования и авто-исправления кода.
- **`src/`** разделён на модули:
  - **`hazard/`** — реализация hazard pointers;
  - **`lf/`** — lock-free очередь и стек;
  - **`metrics/`** — интерфейс `IMetric`, базовые классы `<...>MetricBase<T>` и готовые метрики, реестр `Registry` и `MetricsWriter`;
  - **`utils/`** — вспомогательные структуры (`IntrusiveList<T>`).
- **`tests/`** — unit- и стресс-тесты каждого компонента библиотеки.

## Иструкция по сборке и запуску

```bash
# склонируйте репозиторий
git clone https://github.com/pr1kol2005/vk_metrics_lib.git
cd vk_metrics_lib

# выполните сборку проекта с необходимыми флагами
cmake -B build -D BUILD_TESTS=ON -D BUILD_EXAMPLES=ON
cmake --build build

# запустите желаемые примеры
./bin/cpp_http
./bin/custom

# запустите желаемые тесты
./bin/lock_free_stack_stress
./bin/metrics_unit
```
